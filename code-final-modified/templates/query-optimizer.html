<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL Query Optimizer - CrossDB Analyzer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="header-left">
                    <h1>üöÄ SQL Query Optimizer</h1>
                    <p class="subtitle">AI-powered query optimization with hints, join improvements, and best practices</p>
                </div>
                <div class="header-right">
                    <button class="btn-secondary" onclick="resetQuery()">üîÑ Reset</button>
                    <button class="btn-home" onclick="goHome()">üè† Home</button>
                </div>
            </div>
        </header>

        <div class="tab-content active">
            <div class="card">
                <h2>üìù Enter Your SQL Query</h2>
                <p class="info-text">
                    Paste your SQL query below and our AI will analyze it to provide optimization suggestions,
                    performance hints, and best practices.
                </p>

                <!-- Database Type Selection -->
                <div class="form-group">
                    <label for="dbType">Database Type:</label>
                    <select id="dbType" onchange="updatePlaceholder()">
                        <option value="oracle">Oracle Database</option>
                        <option value="postgresql">PostgreSQL</option>
                        <option value="mysql">MySQL</option>
                        <option value="sqlserver">SQL Server</option>
                        <option value="databricks">Databricks SQL</option>
                        <option value="snowflake">Snowflake</option>
                    </select>
                    <small>Select your target database for specific optimization hints</small>
                </div>

                <!-- Original Query Input -->
                <div class="form-group">
                    <label for="originalQuery">Your SQL Query:</label>
                    <textarea id="originalQuery" rows="12" placeholder="Enter your SQL query here...
Example:
SELECT * FROM employees e, departments d 
WHERE e.department_id = d.department_id 
AND e.salary > 50000 
ORDER BY e.last_name"></textarea>
                    <small>Enter the SQL query you want to optimize</small>
                </div>

                            <!-- Optimization Options -->
                            <div class="form-group">
                                <label>Optimization Focus:</label>
                                <div class="checkbox-group">
                                    <label style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 8px 12px; border-radius: 6px; font-weight: bold;">
                                        <input type="checkbox" id="useAI" checked> ü§ñ Use Live AI Model (OpenAI/Gemini)
                                    </label>
                                    <label>
                                        <input type="checkbox" id="optHints" checked> Add Query Hints
                                    </label>                        <label>
                            <input type="checkbox" id="optJoins" checked> Optimize JOINs
                        </label>
                        <label>
                            <input type="checkbox" id="optIndexes" checked> Index Recommendations
                        </label>
                        <label>
                            <input type="checkbox" id="optSubqueries" checked> Optimize Subqueries
                        </label>
                        <label>
                            <input type="checkbox" id="optBestPractices" checked> Apply Best Practices
                        </label>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="button-group">
                    <button class="btn btn-primary" onclick="optimizeQuery()">
                        <span class="btn-icon">ü§ñ</span> Optimize Query
                    </button>
                    <button class="btn btn-success" onclick="analyzeExecutionPlan()" style="display: none;" id="analyzePlanBtn">
                        <span class="btn-icon">üìä</span> Analyze Execution Plan
                    </button>
                </div>

                <!-- Loading Indicator -->
                <div id="loading" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>Analyzing and optimizing your query...</p>
                </div>

                <!-- Results Section -->
                <div id="results" class="results" style="display: none;">
                    <h3>‚ú® Optimization Results</h3>
                    
                    <!-- Summary Stats -->
                    <div id="optimizationSummary" class="comparison-summary">
                        <!-- Will be populated by JS -->
                    </div>

                    <!-- Optimized Query -->
                    <div class="table-result">
                        <h4>üéØ Optimized Query</h4>
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 6px; margin-top: 10px;">
                            <pre id="optimizedQuery" style="margin: 0; white-space: pre-wrap; font-family: 'Consolas', monospace; font-size: 14px; color: #2c3e50;"></pre>
                        </div>
                                            <div style="margin-top: 10px; display: flex; gap: 10px;">
                                                <button class="btn btn-primary" onclick="copyOptimizedQuery()">
                                                    üìã Copy Optimized Query
                                                </button>
                                                <button class="btn btn-success" onclick="exportOptimizedQueryToTXT()">
                                                    üíæ Export to TXT File
                                                </button>
                                            </div>
                                        </div>
                    <!-- Optimization Suggestions -->
                    <div class="table-result">
                        <h4>üí° Optimization Suggestions</h4>
                        <div id="suggestions" style="margin-top: 15px;">
                            <!-- Will be populated by JS -->
                        </div>
                    </div>

                    <!-- Performance Improvements -->
                    <div class="table-result">
                        <h4>‚ö° Performance Improvements</h4>
                        <div id="improvements" style="margin-top: 15px;">
                            <!-- Will be populated by JS -->
                        </div>
                    </div>

                    <!-- Index Recommendations -->
                    <div class="table-result" id="indexSection" style="display: none;">
                        <h4>üîç Index Recommendations</h4>
                        <div id="indexRecommendations" style="margin-top: 15px;">
                            <!-- Will be populated by JS -->
                        </div>
                    </div>

                    <!-- Query Comparison -->
                    <div class="table-result">
                        <h4>üìä Before vs After Comparison</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
                            <div>
                                <h5 style="color: #dc3545; margin-bottom: 10px;">‚ùå Original Query</h5>
                                <div style="background: #fff3cd; padding: 15px; border-radius: 6px; border-left: 4px solid #ffc107;">
                                    <pre id="originalQueryDisplay" style="margin: 0; white-space: pre-wrap; font-family: 'Consolas', monospace; font-size: 12px;"></pre>
                                </div>
                            </div>
                            <div>
                                <h5 style="color: #28a745; margin-bottom: 10px;">‚úÖ Optimized Query</h5>
                                <div style="background: #d4edda; padding: 15px; border-radius: 6px; border-left: 4px solid #28a745;">
                                    <pre id="optimizedQueryDisplay" style="margin: 0; white-space: pre-wrap; font-family: 'Consolas', monospace; font-size: 12px;"></pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Error Display -->
                <div id="error" class="error" style="display: none;"></div>
            </div>
        </div>

        <footer>
            <p>&copy; 2024 CrossDB Analyzer - Amdocs Data Team | AI-Powered Query Optimization</p>
        </footer>
    </div>

    <script src="{{ url_for('static', filename='js/session-manager.js') }}"></script>
    <script src="{{ url_for('static', filename='js/query-optimizer.js') }}"></script>
    <script>
        function goHome() {
            window.location.href = '/';
        }

        function resetQuery() {
            document.getElementById('originalQuery').value = '';
            document.getElementById('results').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            
            // Show success notification
            const notification = document.createElement('div');
            notification.className = 'success-toast';
            notification.textContent = 'Query editor reset successfully!';
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('hiding');
                setTimeout(() => notification.remove(), 300);
            }, 2000);
        }

        function updatePlaceholder() {
            const dbType = document.getElementById('dbType').value;
            const textarea = document.getElementById('originalQuery');
            
            const examples = {
                oracle: `SELECT * FROM employees e, departments d 
WHERE e.department_id = d.department_id 
AND e.salary > 50000 
ORDER BY e.last_name`,
                postgresql: `SELECT * FROM employees e 
INNER JOIN departments d ON e.department_id = d.department_id 
WHERE e.salary > 50000 
ORDER BY e.last_name`,
                mysql: `SELECT * FROM employees e 
INNER JOIN departments d ON e.department_id = d.department_id 
WHERE e.salary > 50000 
ORDER BY e.last_name`,
                sqlserver: `SELECT * FROM employees e WITH (NOLOCK)
INNER JOIN departments d ON e.department_id = d.department_id 
WHERE e.salary > 50000 
ORDER BY e.last_name`,
                databricks: `SELECT * FROM employees e 
JOIN departments d ON e.department_id = d.department_id 
WHERE e.salary > 50000 
ORDER BY e.last_name`,
                snowflake: `SELECT * FROM employees e 
JOIN departments d ON e.department_id = d.department_id 
WHERE e.salary > 50000 
ORDER BY e.last_name`
            };
            
            textarea.placeholder = `Enter your SQL query here...\nExample for ${dbType}:\n${examples[dbType] || examples.oracle}`;
        }
    </script>
</body>
</html>
